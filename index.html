<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íë§ˆì¼“ CRM ì„¸ê·¸ë¨¼íŠ¸ ëŒ€ì‹œë³´ë“œ</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/papaparse@5/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import { PREDEFINED_SEGMENTS, SUPABASE_CONFIG, BATCH_SIZES } from './src/config/constants.js';
    import { enrichUserData, classifySegments, parseAgree } from './src/utils/dataFormatter.js';

    const { useState, useEffect } = React;

    const supabase = window.supabase.createClient(
      SUPABASE_CONFIG.URL,
      SUPABASE_CONFIG.KEY
    );

    const logs = [];

    const addLog = (message, type = 'info') => {
      console.log(`[${type}] ${message}`);
      logs.push({ message, type, time: new Date().toLocaleTimeString() });
    };

    function CRMDashboard() {
      const [activeTab, setActiveTab] = useState('predefined');
      const [activeCategory, setActiveCategory] = useState('íœ´ë©´');
      const [segments, setSegments] = useState(null);
      const [loading, setLoading] = useState(false);
      const [dbStats, setDbStats] = useState({ users: 0, orders: 0, coupons: 0 });
      const [campaignIds, setCampaignIds] = useState({});
      const [testUserIds, setTestUserIds] = useState({});
      const [propertyNames, setPropertyNames] = useState({});
      const [propertyValues, setPropertyValues] = useState({});
      const [customSegments, setCustomSegments] = useState([]);
      const [newSegment, setNewSegment] = useState({
        name: '',
        conditions: {
          signupDaysMin: '',
          signupDaysMax: '',
          totalAmountMin: '',
          totalAmountMax: '',
          orderCountMin: '',
          orderCountMax: '',
          grade: '',
          avgCycleMin: '',
          avgCycleMax: '',
          daysSinceOrderMin: '',
          daysSinceOrderMax: '',
          couponCountMin: '',
          couponCountMax: '',
          martEnabled: true
        }
      });

      useEffect(() => {
        const loadStats = async () => {
          try {
            const [usersRes, ordersRes, couponsRes, customSegsRes] = await Promise.all([
              supabase.from('users').select('*', { count: 'exact', head: true }),
              supabase.from('orders').select('*', { count: 'exact', head: true }),
              supabase.from('coupons').select('*', { count: 'exact', head: true }),
              supabase.from('custom_segments').select('*').order('created_at', { ascending: false })
            ]);

            setDbStats({
              users: usersRes.count || 0,
              orders: ordersRes.count || 0,
              coupons: couponsRes.count || 0
            });
            
            setCustomSegments(customSegsRes.data || []);
            addLog('DB í†µê³„ ë° ì»¤ìŠ¤í…€ ì„¸ê·¸ë¨¼íŠ¸ ë¡œë“œ ì™„ë£Œ', 'success');
          } catch (error) {
            addLog(`ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
          }
        };
        
        addLog('ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì¤‘...', 'info');
        loadStats();
      }, []);

      const analyzeSegments = async () => {
        setLoading(true);
        addLog('ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ ì‹œì‘... (30-60ì´ˆ ì†Œìš”)', 'info');

        try {
          const [usersRes, ordersRes, couponsRes] = await Promise.all([
            supabase.from('users').select('*'),
            supabase.from('orders').select('*'),
            supabase.from('coupons').select('*')
          ]);

          const users = usersRes.data;
          const orders = ordersRes.data;
          const coupons = couponsRes.data;

          addLog(`ë°ì´í„° ë¡œë“œ: users ${users.length}ëª…, orders ${orders.length}ê±´`, 'info');

          const orderStats = {};
          orders.forEach(order => {
            const uid = order.user_id;
            if (!orderStats[uid]) {
              orderStats[uid] = { orders: [], totalAmount: 0, lastOrderDate: null };
            }
            orderStats[uid].orders.push(order);
            orderStats[uid].totalAmount += (order.real_payment || 0) + (order.qmoney_payment || 0);
            
            const orderDate = new Date(order.order_date);
            if (!orderStats[uid].lastOrderDate || orderDate > orderStats[uid].lastOrderDate) {
              orderStats[uid].lastOrderDate = orderDate;
            }
          });

          const couponMap = {};
          coupons.forEach(c => {
            couponMap[c.user_id] = c.valid_coupon_count || 0;
          });

          // ê¸°ë³¸ ì„¸ê·¸ë¨¼íŠ¸ ì´ˆê¸°í™”
          const allSegments = {};
          Object.keys(PREDEFINED_SEGMENTS).forEach(category => {
            PREDEFINED_SEGMENTS[category].forEach(seg => {
              allSegments[seg.name] = [];
            });
          });

          // ì»¤ìŠ¤í…€ ì„¸ê·¸ë¨¼íŠ¸ ì´ˆê¸°í™”
          customSegments.forEach(cs => {
            allSegments[cs.name] = [];
          });

          const now = new Date();
          users.forEach((user, idx) => {
            if (idx % 10000 === 0) {
              addLog(`ì§„í–‰ë¥ : ${Math.floor(idx / users.length * 100)}%`, 'info');
            }

            const uid = user.user_id;
            const stats = orderStats[uid] || { orders: [], totalAmount: 0, lastOrderDate: null };
            const couponCount = couponMap[uid] || 0;
            const signupDate = new Date(user.signup_date);
            const daysSinceSignup = (now - signupDate) / (1000 * 60 * 60 * 24);
            const daysSinceOrder = stats.lastOrderDate 
              ? (now - stats.lastOrderDate) / (1000 * 60 * 60 * 24)
              : 999;

            const threeMonthsAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
            const recentOrders = stats.orders.filter(o => new Date(o.order_date) >= threeMonthsAgo);
            const recentAmount = recentOrders.reduce((sum, o) => sum + (o.real_payment || 0) + (o.qmoney_payment || 0), 0);
            const avgOrderAmount = recentOrders.length > 0 ? recentAmount / recentOrders.length : 0;

            const enriched = enrichUserData(user, orderStats, couponMap);
            
            // ê¸°ë³¸ ì„¸ê·¸ë¨¼íŠ¸ ë¶„ë¥˜ (src/utils/dataFormatter.jsì—ì„œ ë¡œì§ ì‚¬ìš©)
            const segmentNames = classifySegments(
              enriched,
              stats,
              daysSinceOrder,
              daysSinceSignup,
              recentOrders,
              avgOrderAmount,
              couponCount
            );

            segmentNames.forEach(name => {
              if (allSegments[name]) {
                allSegments[name].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: name });
              }
            });

            // ì»¤ìŠ¤í…€ ì„¸ê·¸ë¨¼íŠ¸ ë§¤ì¹­
            customSegments.forEach(cs => {
              let match = true;
              const c = cs.conditions;

              if (c.martEnabled && !user.mart_is_enabled) match = false;
              if (c.signupDaysMin && daysSinceSignup < parseInt(c.signupDaysMin)) match = false;
              if (c.signupDaysMax && daysSinceSignup > parseInt(c.signupDaysMax)) match = false;
              if (c.totalAmountMin && stats.totalAmount < parseInt(c.totalAmountMin)) match = false;
              if (c.totalAmountMax && stats.totalAmount > parseInt(c.totalAmountMax)) match = false;
              if (c.orderCountMin && stats.orders.length < parseInt(c.orderCountMin)) match = false;
              if (c.orderCountMax && stats.orders.length > parseInt(c.orderCountMax)) match = false;
              if (c.grade && user.grade_name !== c.grade) match = false;

              if (match) {
                allSegments[cs.name].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: cs.name });
              }
            });
          });

          setSegments(allSegments);
          addLog('âœ“ ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ ì™„ë£Œ!', 'success');
        } catch (error) {
          addLog(`ë¶„ì„ ì‹¤íŒ¨: ${error.message}`, 'error');
        } finally {
          setLoading(false);
        }
      };

      const downloadCSV = (segmentName) => {
        if (!segments || !segments[segmentName]) return;
        const data = segments[segmentName];
        const csv = Papa.unparse(data);
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${segmentName}_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        addLog(`${segmentName} CSV ë‹¤ìš´ë¡œë“œ`, 'success');
      };

      const saveCustomSegment = async () => {
        if (!newSegment.name) {
          addLog('ì„¸ê·¸ë¨¼íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
          return;
        }

        try {
          const { error } = await supabase
            .from('custom_segments')
            .insert([{ name: newSegment.name, conditions: newSegment.conditions }]);

          if (error) throw error;

          addLog(`ì»¤ìŠ¤í…€ ì„¸ê·¸ë¨¼íŠ¸ "${newSegment.name}" ì €ì¥ ì™„ë£Œ`, 'success');
          
          const { data } = await supabase.from('custom_segments').select('*');
          setCustomSegments(data || []);
          
          setNewSegment({
            name: '',
            conditions: {
              signupDaysMin: '',
              signupDaysMax: '',
              totalAmountMin: '',
              totalAmountMax: '',
              orderCountMin: '',
              orderCountMax: '',
              grade: '',
              avgCycleMin: '',
              avgCycleMax: '',
              daysSinceOrderMin: '',
              daysSinceOrderMax: '',
              couponCountMin: '',
              couponCountMax: '',
              martEnabled: true
            }
          });
        } catch (error) {
          addLog(`ì„¸ê·¸ë¨¼íŠ¸ ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
      };

      const deleteCustomSegment = async (segmentName) => {
        if (!confirm(`"${segmentName}" ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
          const { error } = await supabase
            .from('custom_segments')
            .delete()
            .eq('name', segmentName);

          if (error) throw error;

          addLog(`ì„¸ê·¸ë¨¼íŠ¸ "${segmentName}" ì‚­ì œ ì™„ë£Œ`, 'success');
          
          const { data } = await supabase.from('custom_segments').select('*');
          setCustomSegments(data || []);
        } catch (error) {
          addLog(`ì„¸ê·¸ë¨¼íŠ¸ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
      };

      const renderSegmentCard = (name, users, info, isCustom) => {
        if (!users || users.length === 0) return null;
        
        const pushUsers = users.filter(u => u.í‘¸ì‹œê°€ëŠ¥).length;
        const smsUsers = users.filter(u => u.SMSê°€ëŠ¥).length;
        const alimtalkUsers = users.filter(u => u.ì•Œë¦¼í†¡ê°€ëŠ¥).length;

        return (
          <div key={name} className="bg-white rounded-lg shadow p-4 hover:shadow-lg transition">
            <div className="mb-3">
              <div className="flex items-center justify-between">
                <h3 className="font-bold text-lg">
                  {name} <span className="text-orange-600">({users.length.toLocaleString()}ëª…)</span>
                </h3>
                {isCustom && (
                  <button
                    onClick={() => deleteCustomSegment(name)}
                    className="text-red-500 text-sm hover:text-red-700"
                  >
                    ğŸ—‘ï¸ ì‚­ì œ
                  </button>
                )}
              </div>
              {info && (
                <div className="text-xs text-gray-600 mt-1">
                  <div className="font-medium">ğŸ“‹ {info.conditions}</div>
                  {info.description && <div className="text-gray-500 mt-0.5">{info.description}</div>}
                </div>
              )}
              <div className="text-xs text-gray-500 mt-1">
                ğŸ“± í‘¸ì‹œ: {pushUsers.toLocaleString()}ëª… | ğŸ’¬ SMS: {smsUsers.toLocaleString()}ëª… | ğŸ’Œ ì•Œë¦¼í†¡: {alimtalkUsers.toLocaleString()}ëª…
              </div>
            </div>

            <button
              onClick={() => downloadCSV(name)}
              className="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 text-sm transition font-medium"
            >
              ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-orange-50 to-orange-100 p-6">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h1 className="text-3xl font-bold text-orange-600 mb-2">ğŸ›’ íë§ˆì¼“ CRM ì„¸ê·¸ë¨¼íŠ¸ ëŒ€ì‹œë³´ë“œ</h1>
              <p className="text-gray-600">
                Supabase + Vercel | {dbStats.users.toLocaleString()}ëª… ê´€ë¦¬ì¤‘
              </p>
            </div>

            <div className="grid grid-cols-3 gap-4 mb-6">
              <div className="bg-white rounded-lg shadow p-4">
                <div className="text-sm text-gray-500 mb-1">ğŸ“Š Users</div>
                <div className="text-2xl font-bold text-orange-600">{dbStats.users.toLocaleString()}ëª…</div>
              </div>
              <div className="bg-white rounded-lg shadow p-4">
                <div className="text-sm text-gray-500 mb-1">ğŸ›ï¸ Orders</div>
                <div className="text-2xl font-bold text-blue-600">{dbStats.orders.toLocaleString()}ê±´</div>
              </div>
              <div className="bg-white rounded-lg shadow p-4">
                <div className="text-sm text-gray-500 mb-1">ğŸŸï¸ Coupons</div>
                <div className="text-2xl font-bold text-green-600">{dbStats.coupons.toLocaleString()}ê±´</div>
              </div>
            </div>

            <button
              onClick={analyzeSegments}
              disabled={loading || dbStats.users === 0}
              className="w-full bg-orange-500 text-white py-3 rounded-lg font-bold hover:bg-orange-600 disabled:bg-gray-300 transition mb-6"
            >
              {loading ? 'â³ ë¶„ì„ ì¤‘... (30-60ì´ˆ)' : 'ğŸ¯ ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ ì‹œì‘'}
            </button>

            {segments && (
              <>
                <div className="bg-white rounded-lg shadow mb-6">
                  <div className="flex border-b">
                    <button
                      onClick={() => setActiveTab('predefined')}
                      className={`flex-1 py-3 font-bold ${activeTab === 'predefined' ? 'bg-orange-500 text-white' : 'text-gray-600 hover:bg-gray-50'}`}
                    >
                      ğŸ“Š ê¸°ë³¸ ì„¸ê·¸ë¨¼íŠ¸
                    </button>
                    <button
                      onClick={() => setActiveTab('custom')}
                      className={`flex-1 py-3 font-bold ${activeTab === 'custom' ? 'bg-orange-500 text-white' : 'text-gray-600 hover:bg-gray-50'}`}
                    >
                      âš™ï¸ ì»¤ìŠ¤í…€ ({customSegments.length})
                    </button>
                  </div>

                  {activeTab === 'predefined' && (
                    <div className="p-6">
                      <div className="flex gap-2 mb-4 flex-wrap">
                        {Object.keys(PREDEFINED_SEGMENTS).map(category => (
                          <button
                            key={category}
                            onClick={() => setActiveCategory(category)}
                            className={`px-4 py-2 rounded-lg font-medium ${
                              activeCategory === category
                                ? 'bg-orange-500 text-white'
                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                          >
                            {category}
                          </button>
                        ))}
                      </div>

                      <div className="space-y-4">
                        {PREDEFINED_SEGMENTS[activeCategory].map(seg => 
                          renderSegmentCard(seg.name, segments[seg.name], seg, false)
                        )}
                      </div>
                    </div>
                  )}

                  {activeTab === 'custom' && (
                    <div className="p-6">
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 className="font-bold text-blue-900 mb-3">â• ìƒˆ ì»¤ìŠ¤í…€ ì„¸ê·¸ë¨¼íŠ¸ ë§Œë“¤ê¸°</h3>
                        
                        <div className="mb-3">
                          <input
                            type="text"
                            placeholder="ì„¸ê·¸ë¨¼íŠ¸ ì´ë¦„"
                            value={newSegment.name}
                            onChange={(e) => setNewSegment({...newSegment, name: e.target.value})}
                            className="w-full border rounded px-3 py-2 mb-2"
                          />
                          <button
                            onClick={saveCustomSegment}
                            className="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 font-medium"
                          >
                            ğŸ’¾ ì €ì¥
                          </button>
                        </div>
                      </div>

                      <div className="space-y-4">
                        {customSegments.map(cs =>
                          renderSegmentCard(cs.name, segments[cs.name], cs, true)
                        )}
                      </div>
                    </div>
                  )}
                </div>
              </>
            )}

            <div className="bg-white rounded-lg shadow-lg p-4">
              <h3 className="font-bold mb-3">ğŸ“‹ ë¡œê·¸</h3>
              <div className="h-64 overflow-y-auto space-y-1 text-sm bg-gray-50 p-3 rounded font-mono">
                {logs.length === 0 ? (
                  <div className="text-gray-400 text-center py-8">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                ) : (
                  logs.map((log, idx) => (
                    <div
                      key={idx}
                      className={`flex gap-2 ${
                        log.type === 'error'
                          ? 'text-red-600'
                          : log.type === 'success'
                          ? 'text-green-600'
                          : 'text-gray-600'
                      }`}
                    >
                      <span className="text-gray-400">[{log.time}]</span>
                      <span>{log.message}</span>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<CRMDashboard />);
  </script>
</body>
</html>
