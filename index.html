<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íë§ˆì¼“ CRM ì„¸ê·¸ë¨¼íŠ¸ ëŒ€ì‹œë³´ë“œ</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/papaparse@5/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const supabase = window.supabase.createClient(
      'https://htcxkbijmiptoubmkhkm.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Y3hyYmlqbWlwdG91Ym1raGttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MjA2OTcsImV4cCI6MjA3ODk5NjY5N30.JGTUpL5spuYEvXdI3u3f3qbo6n2ztGSVwHrZijB4i8'
    );

    const PREDEFINED_SEGMENTS = {
      íœ´ë©´: [
        { 
          name: 'ê³ ê°€ì¹˜_íœ´ë©´', 
          conditions: 'ë¯¸ì£¼ë¬¸ 60ì¼+ & ëˆ„ì êµ¬ë§¤ 20ë§Œì›+',
          description: 'ì¬í™œì„±í™” ìµœìš°ì„  íƒ€ê²Ÿ'
        },
        { 
          name: 'ì¤‘ê°€ì¹˜_íœ´ë©´', 
          conditions: 'ë¯¸ì£¼ë¬¸ 60ì¼+ & ëˆ„ì êµ¬ë§¤ 10ë§Œì›+',
          description: 'ì¤‘ê°€ì¹˜ ì¬í™œì„±í™”'
        },
        { 
          name: 'ì €ê°€ì¹˜_íœ´ë©´', 
          conditions: 'ë¯¸ì£¼ë¬¸ 60ì¼+ & ê¸°íƒ€',
          description: 'ì €ë¹„ìš© ì¬í™œì„±í™” ìº í˜ì¸'
        }
      ],
      í™œì„±: [
        { 
          name: 'VIP', 
          conditions: 'ìµœê·¼ 3ê°œì›” ì£¼ë¬¸ 5íšŒ+ & í‰ê·  ì£¼ë¬¸ê¸ˆì•¡ 5ë§Œì›+',
          description: 'VIP ì „ìš© í˜œíƒ ì œê³µ'
        },
        { 
          name: 'ì¶©ì„±ê³ ê°', 
          conditions: 'ìµœê·¼ 3ê°œì›” ì£¼ë¬¸ 3íšŒ+',
          description: 'ê¾¸ì¤€í•œ êµ¬ë§¤ ìœ ì§€'
        },
        { 
          name: 'ì¼ë°˜í™œì„±', 
          conditions: 'ìµœê·¼ 60ì¼ ë‚´ ì£¼ë¬¸',
          description: 'ê¸°ë³¸ í”„ë¡œëª¨ì…˜ íƒ€ê²Ÿ'
        },
        { 
          name: 'ì¿ í°ë¯¸ì‚¬ìš©_í™œì„±', 
          conditions: 'ë³´ìœ ì¿ í° 3ê°œ+ & ìµœê·¼ ì£¼ë¬¸ì— ë¯¸ì‚¬ìš©',
          description: 'ì¿ í° ì†Œì§„ ìœ ë„'
        }
      ],
      ì‹ ê·œ: [
        { 
          name: 'ì‹ ê·œ_ë¯¸êµ¬ë§¤', 
          conditions: 'ê°€ì… 30ì¼ ì´ë‚´ & ì£¼ë¬¸ 0íšŒ',
          description: 'ì²« êµ¬ë§¤ ì „í™˜ ìµœìš°ì„ '
        },
        { 
          name: 'ì‹ ê·œ_1íšŒêµ¬ë§¤', 
          conditions: 'ê°€ì… 30ì¼ ì´ë‚´ & ì£¼ë¬¸ 1íšŒ',
          description: 'ì¬êµ¬ë§¤ ìœ ë„'
        },
        { 
          name: 'ì‹ ê·œ_2íšŒì´ìƒ', 
          conditions: 'ê°€ì… 30ì¼ ì´ë‚´ & ì£¼ë¬¸ 2íšŒ+',
          description: 'ìš°ìˆ˜ ì‹ ê·œ ê³ ê°'
        }
      ],
      RFM: [
        { 
          name: 'RFM_Champions', 
          conditions: 'ìµœê·¼êµ¬ë§¤(30ì¼ë‚´) & êµ¬ë§¤ë¹ˆë„(5íšŒ+) & êµ¬ë§¤ê¸ˆì•¡(50ë§Œì›+)',
          description: 'ìµœê³  ìš°ìˆ˜ ê³ ê°'
        },
        { 
          name: 'RFM_LoyalCustomers', 
          conditions: 'ìµœê·¼êµ¬ë§¤(60ì¼ë‚´) & êµ¬ë§¤ë¹ˆë„(3íšŒ+) & êµ¬ë§¤ê¸ˆì•¡(30ë§Œì›+)',
          description: 'ì¶©ì„± ê³ ê°'
        },
        { 
          name: 'RFM_AtRisk', 
          conditions: 'ìµœê·¼êµ¬ë§¤(60-90ì¼) & ê³¼ê±°í™œì„±(êµ¬ë§¤ê¸ˆì•¡20ë§Œì›+)',
          description: 'ì´íƒˆ ìœ„í—˜ ê³ ê°'
        },
        { 
          name: 'RFM_CantLose', 
          conditions: 'ìµœê·¼êµ¬ë§¤(90ì¼+) & ê³¼ê±°ìš°ìˆ˜(êµ¬ë§¤ê¸ˆì•¡50ë§Œì›+)',
          description: 'ìƒì–´ì„  ì•ˆë  ê³ ê°'
        }
      ]
    };

    const NOTIFLY_CONFIG = {
      PROJECT_ID: 'f2e198e2448959908fe4f8e540f4057f'
    };

    const logs = [];

    const addLog = (message, type = 'info') => {
      console.log(`[${type}] ${message}`);
      logs.push({ message, type, time: new Date().toLocaleTimeString() });
    };

    const parseAgree = (value) => {
      if (value === 'true' || value === true) return true;
      if (value === 'false' || value === false) return false;
      return false;
    };

    function CRMDashboard() {
      const [activeTab, setActiveTab] = useState('predefined');
      const [activeCategory, setActiveCategory] = useState('íœ´ë©´');
      const [segments, setSegments] = useState(null);
      const [loading, setLoading] = useState(false);
      const [dbStats, setDbStats] = useState({ users: 0, orders: 0, coupons: 0 });

      useEffect(() => {
        const loadStats = async () => {
          try {
            const [usersRes, ordersRes, couponsRes] = await Promise.all([
              supabase.from('users').select('*', { count: 'exact', head: true }),
              supabase.from('orders').select('*', { count: 'exact', head: true }),
              supabase.from('coupons').select('*', { count: 'exact', head: true })
            ]);

            setDbStats({
              users: usersRes.count || 0,
              orders: ordersRes.count || 0,
              coupons: couponsRes.count || 0
            });
            addLog('DB í†µê³„ ë¡œë“œ ì™„ë£Œ', 'success');
          } catch (error) {
            addLog(`DB í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, 'error');
          }
        };
        
        addLog('ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì¤‘...', 'info');
        loadStats();
      }, []);

      const analyzeSegments = async () => {
        setLoading(true);
        addLog('ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ ì‹œì‘... (30-60ì´ˆ ì†Œìš”)', 'info');

        try {
          const [usersRes, ordersRes, couponsRes] = await Promise.all([
            supabase.from('users').select('*'),
            supabase.from('orders').select('*'),
            supabase.from('coupons').select('*')
          ]);

          const users = usersRes.data;
          const orders = ordersRes.data;
          const coupons = couponsRes.data;

          addLog(`ë°ì´í„° ë¡œë“œ: users ${users.length}ëª…, orders ${orders.length}ê±´`, 'info');

          const orderStats = {};
          orders.forEach(order => {
            const uid = order.user_id;
            if (!orderStats[uid]) {
              orderStats[uid] = { orders: [], totalAmount: 0, lastOrderDate: null };
            }
            orderStats[uid].orders.push(order);
            orderStats[uid].totalAmount += (order.real_payment || 0) + (order.qmoney_payment || 0);
            
            const orderDate = new Date(order.order_date);
            if (!orderStats[uid].lastOrderDate || orderDate > orderStats[uid].lastOrderDate) {
              orderStats[uid].lastOrderDate = orderDate;
            }
          });

          const couponMap = {};
          coupons.forEach(c => {
            couponMap[c.user_id] = c.valid_coupon_count || 0;
          });

          const allSegments = {
            'ê³ ê°€ì¹˜_íœ´ë©´': [],
            'ì¤‘ê°€ì¹˜_íœ´ë©´': [],
            'ì €ê°€ì¹˜_íœ´ë©´': [],
            'VIP': [],
            'ì¶©ì„±ê³ ê°': [],
            'ì¼ë°˜í™œì„±': [],
            'ì‹ ê·œ_ë¯¸êµ¬ë§¤': [],
            'ì‹ ê·œ_1íšŒêµ¬ë§¤': [],
            'ì‹ ê·œ_2íšŒì´ìƒ': [],
            'ì¿ í°ë¯¸ì‚¬ìš©_í™œì„±': [],
            'RFM_Champions': [],
            'RFM_LoyalCustomers': [],
            'RFM_AtRisk': [],
            'RFM_CantLose': []
          };

          const now = new Date();
          users.forEach((user, idx) => {
            if (idx % 10000 === 0) {
              addLog(`ì§„í–‰ë¥ : ${Math.floor(idx / users.length * 100)}%`, 'info');
            }

            const uid = user.user_id;
            const stats = orderStats[uid] || { orders: [], totalAmount: 0, lastOrderDate: null };
            const couponCount = couponMap[uid] || 0;
            const signupDate = new Date(user.signup_date);
            const daysSinceSignup = (now - signupDate) / (1000 * 60 * 60 * 24);
            const daysSinceOrder = stats.lastOrderDate ? (now - stats.lastOrderDate) / (1000 * 60 * 60 * 24) : 999;
            
            const threeMonthsAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
            const recentOrders = stats.orders.filter(o => new Date(o.order_date) >= threeMonthsAgo);
            const recentAmount = recentOrders.reduce((sum, o) => sum + (o.real_payment || 0) + (o.qmoney_payment || 0), 0);
            const avgOrderAmount = recentOrders.length > 0 ? recentAmount / recentOrders.length : 0;
            
            const enriched = {
              ...user,
              ì´ì£¼ë¬¸íšŸìˆ˜: stats.orders.length,
              ëˆ„ì êµ¬ë§¤ì•¡: stats.totalAmount,
              ìµœê·¼ì£¼ë¬¸ì¼: stats.lastOrderDate ? stats.lastOrderDate.toISOString().split('T')[0] : 'N/A',
              ë¯¸ì£¼ë¬¸ì¼ìˆ˜: Math.floor(daysSinceOrder),
              ê°€ì…ì¼ìˆ˜: Math.floor(daysSinceSignup),
              ìµœê·¼3ê°œì›”ì£¼ë¬¸: recentOrders.length,
              ìµœê·¼3ê°œì›”êµ¬ë§¤ì•¡: recentAmount,
              í‰ê· ì£¼ë¬¸ê¸ˆì•¡: Math.floor(avgOrderAmount),
              ë³´ìœ ì¿ í°: couponCount,
              í‘¸ì‹œê°€ëŠ¥: parseAgree(user.agree_app_push),
              SMSê°€ëŠ¥: parseAgree(user.agree_sms),
              ì•Œë¦¼í†¡ê°€ëŠ¥: parseAgree(user.agree_alim_talk)
            };

            if (daysSinceSignup <= 30) {
              if (stats.orders.length === 0) {
                allSegments['ì‹ ê·œ_ë¯¸êµ¬ë§¤'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'ì‹ ê·œ_ë¯¸êµ¬ë§¤' });
              } else if (stats.orders.length === 1) {
                allSegments['ì‹ ê·œ_1íšŒêµ¬ë§¤'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'ì‹ ê·œ_1íšŒêµ¬ë§¤' });
              } else {
                allSegments['ì‹ ê·œ_2íšŒì´ìƒ'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'ì‹ ê·œ_2íšŒì´ìƒ' });
              }
            } else if (daysSinceOrder >= 60) {
              if (stats.totalAmount >= 200000) {
                allSegments['ê³ ê°€ì¹˜_íœ´ë©´'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'ê³ ê°€ì¹˜_íœ´ë©´' });
              } else if (stats.totalAmount >= 100000) {
                allSegments['ì¤‘ê°€ì¹˜_íœ´ë©´'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'ì¤‘ê°€ì¹˜_íœ´ë©´' });
              } else {
                allSegments['ì €ê°€ì¹˜_íœ´ë©´'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'ì €ê°€ì¹˜_íœ´ë©´' });
              }
            } else {
              if (recentOrders.length >= 5 && avgOrderAmount >= 50000) {
                allSegments['VIP'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'VIP' });
              } else if (recentOrders.length >= 3) {
                allSegments['ì¶©ì„±ê³ ê°'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'ì¶©ì„±ê³ ê°' });
              } else {
                allSegments['ì¼ë°˜í™œì„±'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'ì¼ë°˜í™œì„±' });
              }

              if (couponCount >= 3 && recentOrders.every(o => !o.coupon_payment || o.coupon_payment === 0)) {
                allSegments['ì¿ í°ë¯¸ì‚¬ìš©_í™œì„±'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'ì¿ í°ë¯¸ì‚¬ìš©_í™œì„±' });
              }
            }

            if (daysSinceOrder <= 30 && stats.orders.length >= 5 && stats.totalAmount >= 500000) {
              allSegments['RFM_Champions'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'RFM_Champions' });
            } else if (daysSinceOrder <= 60 && stats.orders.length >= 3 && stats.totalAmount >= 300000) {
              allSegments['RFM_LoyalCustomers'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'RFM_LoyalCustomers' });
            } else if (daysSinceOrder >= 60 && daysSinceOrder <= 90 && stats.totalAmount >= 200000) {
              allSegments['RFM_AtRisk'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'RFM_AtRisk' });
            } else if (daysSinceOrder > 90 && stats.totalAmount >= 500000) {
              allSegments['RFM_CantLose'].push({ ...enriched, ì„¸ê·¸ë¨¼íŠ¸: 'RFM_CantLose' });
            }
          });

          setSegments(allSegments);
          addLog('âœ“ ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ ì™„ë£Œ!', 'success');
        } catch (error) {
          addLog(`ë¶„ì„ ì‹¤íŒ¨: ${error.message}`, 'error');
        } finally {
          setLoading(false);
        }
      };

      const downloadCSV = (segmentName) => {
        if (!segments || !segments[segmentName]) return;
        const data = segments[segmentName];
        const csv = Papa.unparse(data);
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${segmentName}_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        addLog(`${segmentName} CSV ë‹¤ìš´ë¡œë“œ`, 'success');
      };

      const renderSegmentCard = (name, users, info) => {
        if (!users || users.length === 0) return null;
        
        const pushUsers = users.filter(u => u.í‘¸ì‹œê°€ëŠ¥).length;
        const smsUsers = users.filter(u => u.SMSê°€ëŠ¥).length;

        return (
          <div key={name} className="bg-white rounded-lg shadow p-4 hover:shadow-lg transition">
            <div className="mb-3">
              <h3 className="font-bold text-lg">
                {name} <span className="text-orange-600">({users.length.toLocaleString()}ëª…)</span>
              </h3>
              {info && (
                <div className="text-xs text-gray-600 mt-1">
                  <div className="font-medium">ğŸ“‹ {info.conditions}</div>
                  {info.description && <div className="text-gray-500 mt-0.5">{info.description}</div>}
                </div>
              )}
              <div className="text-xs text-gray-500 mt-1">
                ğŸ“± í‘¸ì‹œ: {pushUsers.toLocaleString()}ëª… | ğŸ’¬ SMS: {smsUsers.toLocaleString()}ëª…
              </div>
            </div>

            <button
              onClick={() => downloadCSV(name)}
              className="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 text-sm transition font-medium"
            >
              ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-orange-50 to-orange-100 p-6">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h1 className="text-3xl font-bold text-orange-600 mb-2">ğŸ›’ íë§ˆì¼“ CRM ì„¸ê·¸ë¨¼íŠ¸ ëŒ€ì‹œë³´ë“œ</h1>
              <p className="text-gray-600">
                Supabase + Vercel | {dbStats.users.toLocaleString()}ëª… ê´€ë¦¬ì¤‘
              </p>
            </div>

            <div className="grid grid-cols-3 gap-4 mb-6">
              <div className="bg-white rounded-lg shadow p-4">
                <div className="text-sm text-gray-500 mb-1">ğŸ“Š Users</div>
                <div className="text-2xl font-bold text-orange-600">{dbStats.users.toLocaleString()}ëª…</div>
              </div>
              <div className="bg-white rounded-lg shadow p-4">
                <div className="text-sm text-gray-500 mb-1">ğŸ›ï¸ Orders</div>
                <div className="text-2xl font-bold text-blue-600">{dbStats.orders.toLocaleString()}ê±´</div>
              </div>
              <div className="bg-white rounded-lg shadow p-4">
                <div className="text-sm text-gray-500 mb-1">ğŸŸï¸ Coupons</div>
                <div className="text-2xl font-bold text-green-600">{dbStats.coupons.toLocaleString()}ê±´</div>
              </div>
            </div>

            <button
              onClick={analyzeSegments}
              disabled={loading || dbStats.users === 0}
              className="w-full bg-orange-500 text-white py-3 rounded-lg font-bold hover:bg-orange-600 disabled:bg-gray-300 transition mb-6"
            >
              {loading ? 'â³ ë¶„ì„ ì¤‘... (30-60ì´ˆ)' : 'ğŸ¯ ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„ ì‹œì‘'}
            </button>

            {segments && (
              <>
                <div className="bg-white rounded-lg shadow mb-6">
                  <div className="flex border-b">
                    <button
                      onClick={() => setActiveTab('predefined')}
                      className={`flex-1 py-3 font-bold ${activeTab === 'predefined' ? 'bg-orange-500 text-white' : 'text-gray-600 hover:bg-gray-50'}`}
                    >
                      ğŸ“Š ê¸°ë³¸ ì„¸ê·¸ë¨¼íŠ¸
                    </button>
                  </div>

                  <div className="p-6">
                    <div className="flex gap-2 mb-4">
                      {Object.keys(PREDEFINED_SEGMENTS).map(category => (
                        <button
                          key={category}
                          onClick={() => setActiveCategory(category)}
                          className={`px-4 py-2 rounded-lg font-medium ${
                            activeCategory === category
                              ? 'bg-orange-500 text-white'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {category}
                        </button>
                      ))}
                    </div>

                    <div className="space-y-4">
                      {PREDEFINED_SEGMENTS[activeCategory].map(seg => 
                        renderSegmentCard(seg.name, segments[seg.name], seg)
                      )}
                    </div>
                  </div>
                </div>
              </>
            )}

            <div className="bg-white rounded-lg shadow-lg p-4 mt-6">
              <h3 className="font-bold mb-3">ğŸ“‹ ë¡œê·¸</h3>
              <div className="h-64 overflow-y-auto space-y-1 text-sm bg-gray-50 p-3 rounded font-mono">
                {logs.length === 0 ? (
                  <div className="text-gray-400 text-center py-8">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                ) : (
                  logs.map((log, idx) => (
                    <div
                      key={idx}
                      className={`flex gap-2 ${
                        log.type === 'error'
                          ? 'text-red-600'
                          : log.type === 'success'
                          ? 'text-green-600'
                          : 'text-gray-600'
                      }`}
                    >
                      <span className="text-gray-400">[{log.time}]</span>
                      <span>{log.message}</span>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<CRMDashboard />);
  </script>
</body>
</html>
